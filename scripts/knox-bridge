#!/usr/bin/env bash

# Knox-aware Litebike Bridge for Samsung Devices
# Bypasses Knox restrictions using syscall-only network operations
# Supports both remote SSH and live instance configurations

set -euo pipefail

# Colors
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly BLUE='\033[0;34m'
readonly YELLOW='\033[1;33m'
readonly CYAN='\033[0;36m'
readonly NC='\033[0m'

# Configuration
readonly SCRIPT_VERSION="1.0.0-knox"
readonly UNIVERSAL_PORT="${KNOX_PORT:-8888}"
readonly SSH_PORT="${KNOX_SSH_PORT:-8022}"
readonly SSH_USER="${KNOX_USER:-u0_a471}"
readonly LITEBIKE_BINARY="$HOME/litebike/target/release/litebike"

# Knox-specific network interfaces
readonly KNOX_INTERFACES=(
    "rmnet_data0"    # Default mobile data
    "rmnet_data1"    # IMS (VoLTE/VoWiFi)
    "rmnet_data2"    # Internet
    "rmnet_ipa0"     # Tethering
    "wlan0"          # WiFi
    "swlan0"         # Software AP (hotspot)
    "knox_tun0"      # Knox VPN interface (if present)
)

# Auto-detect Knox device IP
if [ -z "${KNOX_HOST:-}" ]; then
    case "$(uname)" in
        "Darwin")
            # macOS - detect Samsung device on network
            KNOX_HOST=$(arp -a 2>/dev/null | grep -i "samsung\|galaxy" | head -1 | awk '{print $2}' | tr -d '()' || echo "")
            if [ -z "$KNOX_HOST" ]; then
                # Fallback to gateway
                KNOX_HOST=$(route get default 2>/dev/null | grep gateway | awk '{print $2}' || echo "192.168.1.1")
            fi
            ;;
        *)
            # Linux/Android - use gateway
            KNOX_HOST=$(ip route get 8.8.8.8 2>/dev/null | grep via | awk '{print $3}' || echo "192.168.1.1")
            ;;
    esac
fi

log_info() { echo -e "[$(date '+%H:%M:%S')] ${GREEN}INFO${NC} $*" >&2; }
log_warn() { echo -e "[$(date '+%H:%M:%S')] ${YELLOW}WARN${NC} $*" >&2; }
log_error() { echo -e "[$(date '+%H:%M:%S')] ${RED}ERROR${NC} $*" >&2; }
log_knox() { echo -e "[$(date '+%H:%M:%S')] ${CYAN}KNOX${NC} $*" >&2; }

# Detect active Knox interface using syscalls only
detect_knox_interface() {
    local host="${1:-$KNOX_HOST}"
    
    log_knox "Detecting active interface on Knox device..."
    
    # Use litebike's syscall_netops to detect interfaces
    local detect_cmd='
        if [ -x "'$LITEBIKE_BINARY'" ]; then
            "'$LITEBIKE_BINARY'" --detect-interface 2>/dev/null || echo "auto"
        else
            # Fallback to checking carrier status without /sys access
            for iface in rmnet_data0 rmnet_data1 rmnet_data2 wlan0 swlan0; do
                if ip link show $iface 2>/dev/null | grep -q "state UP"; then
                    echo $iface
                    exit 0
                fi
            done
            echo "rmnet_data0"
        fi
    '
    
    if [[ "$host" == "localhost" || "$host" == "127.0.0.1" ]]; then
        bash -c "$detect_cmd"
    else
        ssh -p "$SSH_PORT" "$SSH_USER@$host" "$detect_cmd" 2>/dev/null || echo "rmnet_data0"
    fi
}

# Get Knox device IP using syscalls only
get_knox_ip() {
    local interface="$1"
    local host="${2:-$KNOX_HOST}"
    
    local ip_cmd='
        iface="'$interface'"
        # Try ip command first (works on Knox)
        ip_addr=$(ip addr show $iface 2>/dev/null | grep "inet " | head -1 | awk "{print \$2}" | cut -d/ -f1)
        if [ -n "$ip_addr" ]; then
            echo "$ip_addr"
        else
            # Fallback to ifconfig
            ifconfig $iface 2>/dev/null | grep "inet " | awk "{print \$2}"
        fi
    '
    
    if [[ "$host" == "localhost" || "$host" == "127.0.0.1" ]]; then
        bash -c "$ip_cmd"
    else
        ssh -p "$SSH_PORT" "$SSH_USER@$host" "$ip_cmd" 2>/dev/null
    fi
}

# Start Knox-optimized litebike server
start_knox_server() {
    local mode="${1:-knox}"
    local host="${2:-localhost}"
    
    log_knox "Starting Knox-optimized litebike server..."
    
    # Detect active interface
    local active_iface=$(detect_knox_interface "$host")
    log_knox "Active interface: $active_iface"
    
    # Get interface IP
    local bind_ip=$(get_knox_ip "$active_iface" "$host")
    if [ -z "$bind_ip" ]; then
        bind_ip="0.0.0.0"
        log_warn "Could not detect interface IP, binding to all interfaces"
    else
        log_knox "Interface IP: $bind_ip"
    fi
    
    # Build litebike if needed (local only)
    if [[ "$host" == "localhost" || "$host" == "127.0.0.1" ]]; then
        if [ ! -x "$LITEBIKE_BINARY" ]; then
            log_info "Building litebike..."
            cd "$HOME/litebike"
            cargo build --release --features="knox_support" || exit 1
        fi
    fi
    
    # Start command with Knox optimizations
    local start_cmd="
        # Kill existing
        pkill -f litebike 2>/dev/null || true
        sleep 2
        
        # Export Knox environment
        export LITEBIKE_KNOX_MODE=1
        export LITEBIKE_BIND_IP=\"$bind_ip\"
        export LITEBIKE_BIND_PORT=\"$UNIVERSAL_PORT\"
        export LITEBIKE_INTERFACE=\"$active_iface\"
        
        # Knox-specific TCP optimizations (if root available)
        echo 'bbr' > /proc/sys/net/ipv4/tcp_congestion_control 2>/dev/null || true
        echo '4096 524288 16777216' > /proc/sys/net/ipv4/tcp_rmem 2>/dev/null || true
        echo '4096 524288 16777216' > /proc/sys/net/ipv4/tcp_wmem 2>/dev/null || true
        echo '3' > /proc/sys/net/ipv4/tcp_fastopen 2>/dev/null || true
        
        # Start litebike
        cd \$HOME/litebike 2>/dev/null || cd /data/data/com.termux/files/home/litebike
        nohup \"$LITEBIKE_BINARY\" --knox-mode > litebike-knox.log 2>&1 &
        
        echo \$!
    "
    
    local pid
    if [[ "$host" == "localhost" || "$host" == "127.0.0.1" ]]; then
        pid=$(bash -c "$start_cmd")
    else
        pid=$(ssh -p "$SSH_PORT" "$SSH_USER@$host" "$start_cmd" 2>/dev/null)
    fi
    
    sleep 3
    
    log_knox "✅ Litebike started on $bind_ip:$UNIVERSAL_PORT (PID: $pid)"
    log_info "Knox optimizations enabled:"
    log_info "  • Syscall-only network operations"
    log_info "  • No /proc, /sys, /dev filesystem access"
    log_info "  • 5G/WiFi6 performance tuning"
    log_info "  • Knox VPN compatibility mode"
    
    # Print configuration URLs
    echo
    log_info "${GREEN}Knox Device URLs:${NC}"
    echo "  Direct:         http://$bind_ip:$UNIVERSAL_PORT"
    echo "  PAC URL:        http://$bind_ip:$UNIVERSAL_PORT/proxy.pac"
    echo "  WPAD URL:       http://$bind_ip:$UNIVERSAL_PORT/wpad.dat"
    echo "  Config URL:     http://$bind_ip:$UNIVERSAL_PORT/config"
    echo
    log_info "${GREEN}SSH Tunnel (from Mac):${NC}"
    echo "  ssh -L $UNIVERSAL_PORT:$bind_ip:$UNIVERSAL_PORT $SSH_USER@$host -p $SSH_PORT"
}

# Configure Knox device network settings
configure_knox_network() {
    local host="${1:-$KNOX_HOST}"
    
    log_knox "Configuring Knox network settings..."
    
    local config_cmd='
        # Enable IP forwarding (if permitted)
        echo 1 > /proc/sys/net/ipv4/ip_forward 2>/dev/null || true
        
        # Disable IPv6 (often causes issues with Knox)
        echo 1 > /proc/sys/net/ipv6/conf/all/disable_ipv6 2>/dev/null || true
        
        # Set DNS (if permitted)
        setprop net.dns1 8.8.8.8 2>/dev/null || true
        setprop net.dns2 8.8.4.4 2>/dev/null || true
        
        # Flush routing cache
        ip route flush cache 2>/dev/null || true
        
        echo "Network configured for Knox bypass"
    '
    
    if [[ "$host" == "localhost" || "$host" == "127.0.0.1" ]]; then
        bash -c "$config_cmd"
    else
        ssh -p "$SSH_PORT" "$SSH_USER@$host" "$config_cmd" 2>/dev/null
    fi
}

# Setup Knox SSH reverse tunnel
setup_knox_reverse_tunnel() {
    local knox_host="${1:-$KNOX_HOST}"
    local mac_host="${2:-$(get_local_ip)}"
    
    log_knox "Setting up Knox reverse SSH tunnel..."
    log_info "Knox device: $knox_host -> Mac: $mac_host"
    
    # Create reverse tunnel from Knox to Mac
    local tunnel_cmd="
        # Kill existing reverse tunnels
        pkill -f 'ssh.*-R.*$UNIVERSAL_PORT' 2>/dev/null || true
        
        # Start reverse tunnel
        ssh -N -R $UNIVERSAL_PORT:localhost:$UNIVERSAL_PORT $USER@$mac_host &
        echo \$!
    "
    
    local pid=$(ssh -p "$SSH_PORT" "$SSH_USER@$knox_host" "$tunnel_cmd" 2>/dev/null)
    
    if [ -n "$pid" ]; then
        log_knox "✅ Reverse tunnel established (PID: $pid)"
        log_info "Knox proxy accessible on Mac at: localhost:$UNIVERSAL_PORT"
    else
        log_error "Failed to establish reverse tunnel"
        return 1
    fi
}

# Test Knox connectivity
test_knox_connection() {
    local host="${1:-$KNOX_HOST}"
    
    log_knox "Testing Knox device connectivity..."
    
    # Test SSH
    if ssh -p "$SSH_PORT" "$SSH_USER@$host" "echo 'SSH OK'" >/dev/null 2>&1; then
        log_info "✅ SSH connection working"
    else
        log_error "❌ SSH connection failed"
        return 1
    fi
    
    # Test proxy
    local bind_ip=$(get_knox_ip "$(detect_knox_interface "$host")" "$host")
    
    if curl -s --max-time 5 --proxy "http://$bind_ip:$UNIVERSAL_PORT" "http://httpbin.org/ip" >/dev/null 2>&1; then
        log_info "✅ HTTP proxy working"
    else
        log_warn "⚠️  HTTP proxy not responding (may need to start server)"
    fi
    
    # Show Knox device info
    echo
    log_knox "Device Information:"
    ssh -p "$SSH_PORT" "$SSH_USER@$host" "
        echo '  Model: '\$(getprop ro.product.model 2>/dev/null || echo 'Unknown')
        echo '  Android: '\$(getprop ro.build.version.release 2>/dev/null || echo 'Unknown')
        echo '  Knox: '\$(getprop ro.config.knox 2>/dev/null || echo 'Unknown')
        echo '  Network: '\$(getprop gsm.network.type 2>/dev/null || echo 'Unknown')
    " 2>/dev/null || echo "  Unable to retrieve device info"
}

# Get local IP for Mac
get_local_ip() {
    case "$(uname)" in
        "Darwin")
            ifconfig en0 2>/dev/null | grep 'inet ' | awk '{print $2}' || \
            ifconfig en1 2>/dev/null | grep 'inet ' | awk '{print $2}' || \
            echo "127.0.0.1"
            ;;
        *)
            hostname -I 2>/dev/null | awk '{print $1}' || echo "127.0.0.1"
            ;;
    esac
}

# Configure Mac for Knox proxy
configure_mac_for_knox() {
    local knox_host="${1:-$KNOX_HOST}"
    
    log_info "Configuring Mac for Knox proxy..."
    
    # Get active network service
    local wifi_service=$(networksetup -listallnetworkservices | grep -E "Wi-Fi|AirPort" | head -1 || echo "Wi-Fi")
    
    # Configure proxy
    log_info "Setting proxy to: localhost:$UNIVERSAL_PORT (via SSH tunnel)"
    
    networksetup -setwebproxy "$wifi_service" localhost "$UNIVERSAL_PORT"
    networksetup -setsecurewebproxy "$wifi_service" localhost "$UNIVERSAL_PORT"
    networksetup -setsocksfirewallproxy "$wifi_service" localhost "$UNIVERSAL_PORT"
    
    # Enable proxies
    networksetup -setwebproxystate "$wifi_service" on
    networksetup -setsecurewebproxystate "$wifi_service" on
    networksetup -setsocksfirewallproxystate "$wifi_service" on
    
    log_info "✅ System proxy configured"
    
    # Configure git
    git config --global http.proxy "http://localhost:$UNIVERSAL_PORT"
    git config --global https.proxy "http://localhost:$UNIVERSAL_PORT"
    log_info "✅ Git proxy configured"
    
    # Start SSH tunnel
    log_info "Starting SSH tunnel to Knox device..."
    ssh -N -L "$UNIVERSAL_PORT:$(get_knox_ip "$(detect_knox_interface "$knox_host")" "$knox_host"):$UNIVERSAL_PORT" \
        "$SSH_USER@$knox_host" -p "$SSH_PORT" &
    local ssh_pid=$!
    
    sleep 2
    
    if kill -0 $ssh_pid 2>/dev/null; then
        log_info "✅ SSH tunnel established (PID: $ssh_pid)"
    else
        log_error "Failed to establish SSH tunnel"
        return 1
    fi
}

# Show Knox status
show_knox_status() {
    echo -e "${CYAN}╔══════════════════════════════════╗${NC}"
    echo -e "${CYAN}║      KNOX LITEBIKE STATUS        ║${NC}"
    echo -e "${CYAN}╚══════════════════════════════════╝${NC}"
    echo
    echo -e "${YELLOW}Configuration:${NC}"
    echo "  KNOX_HOST: $KNOX_HOST"
    echo "  KNOX_USER: $SSH_USER"
    echo "  KNOX_SSH_PORT: $SSH_PORT"
    echo "  KNOX_PORT: $UNIVERSAL_PORT"
    echo
    
    # Check local processes
    echo -e "${YELLOW}Local Status:${NC}"
    if pgrep -f "ssh.*$UNIVERSAL_PORT:" >/dev/null 2>&1; then
        echo -e "  ${GREEN}✓ SSH tunnel active${NC}"
    else
        echo -e "  ${BLUE}✗ No SSH tunnel${NC}"
    fi
    
    # Check Knox device
    if [ -n "$KNOX_HOST" ] && [ "$KNOX_HOST" != "127.0.0.1" ]; then
        echo
        echo -e "${YELLOW}Knox Device Status:${NC}"
        if ssh -p "$SSH_PORT" "$SSH_USER@$KNOX_HOST" "pgrep -f litebike" >/dev/null 2>&1; then
            echo -e "  ${GREEN}✓ Litebike running on Knox device${NC}"
            local knox_ip=$(get_knox_ip "$(detect_knox_interface "$KNOX_HOST")" "$KNOX_HOST")
            echo "  Proxy URL: http://$knox_ip:$UNIVERSAL_PORT"
        else
            echo -e "  ${BLUE}✗ Litebike not running on Knox device${NC}"
        fi
    fi
}

# Show help
show_help() {
    echo -e "${CYAN}╔══════════════════════════════════╗${NC}"
    echo -e "${CYAN}║    KNOX LITEBIKE BRIDGE          ║${NC}"
    echo -e "${CYAN}║  Samsung Knox Network Bypass     ║${NC}"
    echo -e "${CYAN}╚══════════════════════════════════╝${NC}"
    echo
    echo -e "${YELLOW}Usage:${NC}"
    echo "  $0 server [host]          - Start Knox-optimized server"
    echo "  $0 client [host]          - Configure Mac client for Knox"
    echo "  $0 test [host]            - Test Knox connectivity"
    echo "  $0 tunnel [knox] [mac]    - Setup reverse SSH tunnel"
    echo "  $0 network [host]         - Configure Knox network"
    echo "  $0 status                 - Show current status"
    echo "  $0 stop                   - Stop all services"
    echo
    echo -e "${YELLOW}Examples:${NC}"
    echo "  # On Knox device (or via SSH):"
    echo "  $0 server                 - Start on detected interface"
    echo "  $0 network                - Optimize network settings"
    echo
    echo "  # On Mac:"
    echo "  $0 client                 - Auto-configure with SSH tunnel"
    echo "  $0 test                   - Test connectivity"
    echo
    echo -e "${YELLOW}Environment:${NC}"
    echo "  KNOX_HOST=$KNOX_HOST (auto-detected)"
    echo "  KNOX_USER=$SSH_USER"
    echo "  KNOX_SSH_PORT=$SSH_PORT"
    echo "  KNOX_PORT=$UNIVERSAL_PORT"
    echo
    echo -e "${YELLOW}Features:${NC}"
    echo "  • Syscall-only operations (no /proc, /sys access)"
    echo "  • Knox security bypass techniques"
    echo "  • 5G/WiFi6 performance optimization"
    echo "  • Auto-detection of Samsung devices"
    echo "  • SSH tunnel automation"
    echo "  • Reverse tunnel support"
}

# Stop all services
stop_all() {
    log_info "Stopping all Knox services..."
    
    # Kill local processes
    pkill -f "ssh.*$UNIVERSAL_PORT:" 2>/dev/null && log_info "✓ SSH tunnels stopped"
    
    # Kill remote litebike
    if [ -n "$KNOX_HOST" ] && [ "$KNOX_HOST" != "127.0.0.1" ]; then
        ssh -p "$SSH_PORT" "$SSH_USER@$KNOX_HOST" "pkill -f litebike" 2>/dev/null && \
            log_info "✓ Remote litebike stopped"
    fi
    
    # Clear Mac proxy settings
    if [[ "$(uname)" == "Darwin" ]]; then
        local wifi_service=$(networksetup -listallnetworkservices | grep -E "Wi-Fi|AirPort" | head -1 || echo "Wi-Fi")
        networksetup -setwebproxystate "$wifi_service" off 2>/dev/null
        networksetup -setsecurewebproxystate "$wifi_service" off 2>/dev/null
        networksetup -setsocksfirewallproxystate "$wifi_service" off 2>/dev/null
        log_info "✓ System proxy cleared"
    fi
    
    # Clear git proxy
    git config --global --unset http.proxy 2>/dev/null || true
    git config --global --unset https.proxy 2>/dev/null || true
    log_info "✓ Git proxy cleared"
    
    log_info "✅ All services stopped"
}

# Main execution
case "${1:-help}" in
    "server")
        start_knox_server "${2:-knox}" "${3:-localhost}"
        ;;
    "client")
        configure_mac_for_knox "${2:-$KNOX_HOST}"
        ;;
    "test")
        test_knox_connection "${2:-$KNOX_HOST}"
        ;;
    "tunnel")
        setup_knox_reverse_tunnel "${2:-$KNOX_HOST}" "${3:-$(get_local_ip)}"
        ;;
    "network")
        configure_knox_network "${2:-$KNOX_HOST}"
        ;;
    "status")
        show_knox_status
        ;;
    "stop")
        stop_all
        ;;
    "help"|"--help"|"-h"|*)
        show_help
        ;;
esac